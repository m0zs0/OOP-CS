# WPF + MySQL CRUD + xUnit alkalmazása

## Előkészítés
### phpmyadmin:
-Hozd létre a wpf_crud_demo adatbázist.

-Hozd létre a users táblát.
```mysql
CREATE TABLE users (
    id INT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100),
    email VARCHAR(100),
    age INT
);
```
### c#:
-A projektben szükség lesz a MySql.Data NuGet csomagra (Tools → NuGet Package Manager → Package Manager Console): 

```
Install-Package MySql.Data
```

(Vagy jobb klikk a projekteden → Manage NuGet Packages, keresd meg: MySql.Data, kattints a Install gombra)

-Vedd fel a következő névteret: 
```
using MySql.Data.MySqlClient;
```
## Adatbázis-kapcsolat létrehozása:

<details>
<summary>Nyiss le a MainWindow.xaml.cs forrásáért!</summary>

### `MainWindow.xaml.cs` példa:

```c#
using MySql.Data.MySqlClient;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;
namespace Wpf_crud_demo
{
    /// <summary>
    /// Interaction logic for MainWindow.xaml
    /// </summary>
    public partial class MainWindow : Window
    {
        // Kapcsolati string és kapcsolat objektum osztályszinten
        private string connectionString = "server=localhost;user=root;password=;database=wpf_crud_demo;";
        private MySqlConnection conn;
        public MainWindow()
        {
            InitializeComponent();
            conn = new MySqlConnection(connectionString);
            try
            {
                conn.Open();
                System.Diagnostics.Debug.WriteLine("Sikeres kapcsolat"); 
                MessageBox.Show("Sikeres kapcsolat");
                conn.Close();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine("Hiba: " + ex.Message);
                MessageBox.Show("Hiba: "+ex.Message);
            }       
        }
    }
}
```
</details>
Futtatás módja: Debug legyen!

## A programkód:

<details>
<summary>Nyiss le a MainWindow.xaml forrásáért!</summary>

### `MainWindow.xaml` példa:

```c#

<Window x:Class="Wpf_crud_demo.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:local="clr-namespace:Wpf_crud_demo"
        mc:Ignorable="d"
        Title="Wpf CRUD Demo" Height="450" Width="800">
    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        <StackPanel Orientation="Horizontal" Grid.Row="0" Margin="0,0,0,10">
            <!-- Input fields -->
            <Label Content="Név:" Margin="5" ToolTip="Név"/>
            <TextBox x:Name="NameTextBox" Width="120" Margin="5" ToolTip="Név"/>
            <Label Content="Email:" Margin="5" ToolTip="Email"/>
            <TextBox x:Name="EmailTextBox" Width="150" Margin="5" ToolTip="Email"/>
            <Label Content="Életkor:" Margin="5" ToolTip="Életkor"/>
            <TextBox x:Name="AgeTextBox" Width="60" Margin="5" ToolTip="Életkor"/>
        </StackPanel>
        <StackPanel Orientation="Horizontal" Grid.Row="1" Margin="0,0,0,10">
            <Button Content="Hozzáadás" Width="100" Margin="5" Click="AddButton_Click"/>
            <Button Content="Módosítás" Width="100" Margin="5" Click="UpdateButton_Click"/>
            <Button Content="Törlés" Width="100" Margin="5" Click="DeleteButton_Click"/>
            <Button Content="Frissítés" Width="100" Margin="5" Click="LoadData"/>
        </StackPanel>
        <DataGrid x:Name="UsersDataGrid" Grid.Row="2" AutoGenerateColumns="True" SelectionMode="Single" CanUserAddRows = "False" SelectionChanged="UsersDataGrid_SelectionChanged"/>
    </Grid>
</Window>
```
</details>
<details>
<summary>Nyiss le a MainWindow.xaml.cs forrásáért!</summary>

### `MainWindow.xaml.cs` példa:

```c#

using MySql.Data.MySqlClient;
using System.Data;
using System.Text;
using System.Windows;
using System.Windows.Controls;
using System.Windows.Data;
using System.Windows.Documents;
using System.Windows.Input;
using System.Windows.Media;
using System.Windows.Media.Imaging;
using System.Windows.Navigation;
using System.Windows.Shapes;
namespace Wpf_crud_demo
{
    /// <summary>
    /// Interaction logic for MainWindow.xaml
    /// </summary>
    public partial class MainWindow : Window
    {
        // Kapcsolati string és kapcsolat objektum osztályszinten
        private string connectionString = "server=localhost;user=root;password=;database=wpf_crud_demo;";
        private MySqlConnection conn;
        public MainWindow()
        {
            InitializeComponent();
            conn = new MySqlConnection(connectionString);
            LoadData();
            //tesztelés
            /*
            try
            {
                conn.Open();
                System.Diagnostics.Debug.WriteLine("Sikeres kapcsolat");
                MessageBox.Show("Sikeres kapcsolat");
                conn.Close();
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine("Hiba: " + ex.Message);
                MessageBox.Show("Hiba: "+ex.Message);
            } */      
        }
        private void LoadData(object sender = null, RoutedEventArgs e = null)
        {
            try
            {
                // 1. lépés: Megnyitjuk a kapcsolatot a MySQL adatbázissal. Ez szükséges minden adatbázis művelet előtt.
                conn.Open();
                // 2. lépés: SQL lekérdezés, amely az összes rekordot lekéri a 'users' táblából.
                string query = "SELECT * FROM users";
                // 3. lépés: Létrehozunk egy parancsobjektumot, amely végrehajtja a fenti SQL lekérdezést a megnyitott kapcsolaton keresztül.
                // PHP-ben: mysqli_query($conn, "SELECT * FROM users");
                MySqlCommand cmd = new MySqlCommand(query, conn);
                // 4. lépés: Eredménykezelő: az adapter egy köztes réteg, ami lefuttatja a parancsot (cmd).
                // PHP - ben: $result = mysqli_query($conn, "SELECT * FROM users");
                MySqlDataAdapter adapter = new MySqlDataAdapter(cmd);
                // 5. lépés: Létrehozunk egy üres DataTable objektumot, amelybe az adatokat fogjuk betölteni.
                DataTable dt = new DataTable();
                // 6. lépés: Az adapter-ből az eredményt betölti a DataTable-be.
                /* PHP-ben
                    $dt = [];
                    while ($row = mysqli_fetch_assoc($result)) {
                        $dt[] = $row;
                    }
                 */
                adapter.Fill(dt);
                // 7. lépés: A DataGrid vezérlő adatforrását beállítjuk a DataTable nézetére, így megjelennek az adatok a felületen.
                UsersDataGrid.ItemsSource = dt.DefaultView;
                // 8. lépés: Bezárjuk az adatbázis kapcsolatot, hogy ne foglaljon feleslegesen erőforrást.
                conn.Close();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Hiba: " + ex.Message);
            }
        }
        /*
        private void AddButton_Click(object sender, RoutedEventArgs e)
        {
            try
            {
                conn.Open();
                string query = "INSERT INTO users (name, email, age) VALUES (@name, @email, @age)";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                // Hozzáadjuk az SQL parancshoz a @name,... paramétert, és beállítjuk az értékét a NameTextBox szövegére.
                // Ez megakadályozza az SQL injection-t, és biztonságosabb adatküldést tesz lehetővé.
                // PHP-ben: mysqli_prepare + bind_param
                cmd.Parameters.AddWithValue("@name", NameTextBox.Text);
                cmd.Parameters.AddWithValue("@email", EmailTextBox.Text);
                // Ellenőrzött kor
                if (int.TryParse(AgeTextBox.Text, out int age))
                {
                    cmd.Parameters.AddWithValue("@age", age);
                }
                else
                {
                    MessageBox.Show("Kérlek, érvényes életkort adj meg (csak számokat)!", "Hibás adat", MessageBoxButton.OK, MessageBoxImage.Warning);
                    conn.Close(); // Ne felejtsük el bezárni a kapcsolatot!
                    return;       // Korai visszatérés, kilépünk a metódusból, nem fut le az ExecuteNonQuery
                }
                // Végrehajtjuk az SQL parancsot, amely nem ad vissza eredményt (pl. INSERT, UPDATE, DELETE).
                // Ez a metódus visszatér egy egész számmal, ami megmutatja, hány sorra volt hatással.
                // PHP-ben: mysqli_query($conn, $query);
                cmd.ExecuteNonQuery();
                conn.Close();
                LoadData();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Hiba: " + ex.Message);
            }
        }
        private void UpdateButton_Click(object sender, RoutedEventArgs e)
        {
            if (UsersDataGrid.SelectedItem == null) return;
            DataRowView row = (DataRowView)UsersDataGrid.SelectedItem;
            int id = Convert.ToInt32(row["id"]);
            try
            {
                conn.Open();
                string query = "UPDATE users SET name=@name, email=@email, age=@age WHERE id=@id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", id);
                cmd.Parameters.AddWithValue("@name", NameTextBox.Text);
                cmd.Parameters.AddWithValue("@email", EmailTextBox.Text);
                cmd.Parameters.AddWithValue("@age", int.Parse(AgeTextBox.Text));
                cmd.ExecuteNonQuery();
                conn.Close();
                LoadData();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Hiba: " + ex.Message);
            }
        }*/
        /* Javított Add és Update*/
        // Visszatérési érték: (string name, string email, int age) tuple vagy null
        public static (string name, string email, int age)? ValidateUserInput(string name, string email, string ageText)
        {
            if (string.IsNullOrEmpty(name) || string.IsNullOrEmpty(email))
            {
                MessageBox.Show("A név és az email nem lehet üres!", "Hibás adat", MessageBoxButton.OK, MessageBoxImage.Warning);
                return null;
            }
            if (!int.TryParse(ageText, out int age))
            {
                MessageBox.Show("Kérlek, érvényes életkort adj meg (csak számokat)!", "Hibás adat", MessageBoxButton.OK, MessageBoxImage.Warning);
                return null;
            }
            return (name, email, age);
        }
        private void AddButton_Click(object sender, RoutedEventArgs e)
        {
            var userData = ValidateUserInput(NameTextBox.Text.Trim(), EmailTextBox.Text.Trim(), AgeTextBox.Text.Trim());
            if (userData == null) return;
            try
            {
                conn.Open();
                string query = "INSERT INTO users (name, email, age) VALUES (@name, @email, @age)";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@name", userData.Value.name);
                cmd.Parameters.AddWithValue("@email", userData.Value.email);
                cmd.Parameters.AddWithValue("@age", userData.Value.age);
                cmd.ExecuteNonQuery();
                conn.Close();
                LoadData();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Hiba: " + ex.Message);
            }
        }
        private void UpdateButton_Click(object sender, RoutedEventArgs e)
        {
            if (UsersDataGrid.SelectedItem == null) return;
            DataRowView row = (DataRowView)UsersDataGrid.SelectedItem;
            int id = Convert.ToInt32(row["id"]);
            var userData = ValidateUserInput(NameTextBox.Text.Trim(), EmailTextBox.Text.Trim(), AgeTextBox.Text.Trim());
            if (userData == null) return;
            try
            {
                conn.Open();
                string query = "UPDATE users SET name=@name, email=@email, age=@age WHERE id=@id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", id);
                cmd.Parameters.AddWithValue("@name", userData.Value.name);
                cmd.Parameters.AddWithValue("@email", userData.Value.email);
                cmd.Parameters.AddWithValue("@age", userData.Value.age);
                cmd.ExecuteNonQuery();
                conn.Close();
                LoadData();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Hiba: " + ex.Message);
            }
        }
        private void DeleteButton_Click(object sender, RoutedEventArgs e)
        {
            if (UsersDataGrid.SelectedItem == null) return;
            DataRowView row = (DataRowView)UsersDataGrid.SelectedItem;
            int id = Convert.ToInt32(row["id"]);
            try
            {
                conn.Open();
                string query = "DELETE FROM users WHERE id=@id";
                MySqlCommand cmd = new MySqlCommand(query, conn);
                cmd.Parameters.AddWithValue("@id", id);
                cmd.ExecuteNonQuery();
                conn.Close();
                LoadData();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Hiba: " + ex.Message);
            }
        }
        private void UsersDataGrid_SelectionChanged(object sender, SelectionChangedEventArgs e)
        {
            if (UsersDataGrid.SelectedItem is DataRowView row)
            {
                NameTextBox.Text = row["name"].ToString();
                EmailTextBox.Text = row["email"].ToString();
                AgeTextBox.Text = row["age"].ToString();
            }
        }
    }
}

```
</details>

## Tesztek írása:

-Jobb klikk a megoldásra (Solution) → Add → New Project

-Válaszd ki:
`xUnit Test Project`

-Nevezd el pl. WpfCrudDemo.Tests

-A tesztprojektben adj hozzá hivatkozást az eredeti projektre:

Jobb klikk a tesztprojekten → Add → Project Reference → válaszd ki a Wpf_crud_demo projektet

<details>
<summary>Nyiss le a UnitTest1.cs forrásáért!</summary>

### `UnitTest1.cs` példa:

```c#
using Wpf_crud_demo;

namespace WpfCrudDemo.Tests
{
    public class UnitTest1
    {
        [Fact]
        public void ValidateUserInput_ValidData_ReturnsTuple()
        {
        
            // Arrange
            string name = "Teszt";
            string email = "teszt@example.com";
            string age = "25";
        
            // Act
            var result = MainWindow.ValidateUserInput(name, email, age);
        
            // Assert
            // Ellenőrizzük, hogy a result nem null, tehát a metódus sikeresen visszaadott egy értéket. Ez azt jelenti, hogy az input valid volt.
            Assert.NotNull(result);
            // Ellenőrizzük, hogy a visszaadott name mező pontosan "Teszt".
            Assert.Equal("Teszt", result.Value.name);
            // Ellenőrizzük, hogy az email mező "teszt@example.com".
            Assert.Equal("teszt@example.com", result.Value.email);
            // Ellenőrizzük, hogy az age mező értéke 25 (számként).
            Assert.Equal(25, result.Value.age);
        }
        
        [Fact]
        public void ValidateUserInput_EmptyName_ReturnsNull()
        {
        
            // Arrange
            string name = "";
            string email = "teszt@example.com";
            string age = "25";
        
            // Act
            var result = MainWindow.ValidateUserInput(name, email, age);
        
            // Assert
            Assert.Null(result);
        
        }
        
        [Fact]
        public void ValidateUserInput_InvalidAge_ReturnsNull()
        {
        
            // Arrange
            string name = "Teszt";
            string email = "teszt@example.com";
            string age = "abc";
        
            // Act
            var result = MainWindow.ValidateUserInput(name, email, age);
        
            // Assert
            Assert.Null(result);
        }
    }
}
```
</details>

## A setup/teardown logika

-A konstruktorban történik az előkészítés (SetUp megfelelője).

-A Dispose() metódusban történik a takarítás (TearDown megfelelője).

```c#

public class UnitTest1 : IDisposable
{
    private MainWindow _mainWindow;

    // Konstruktor: minden teszt előtt lefut
    public UnitTest1()
    {
        _mainWindow = new MainWindow();
        // Itt lehet például mock inicializálás, adatbázis előkészítés stb.
    }

    // Dispose: minden teszt után lefut
    public void Dispose()
    {
        // Itt lehet például erőforrások felszabadítása, adatbázis tisztítása stb.
        _mainWindow = null;
    }

    [Fact]
    public void ValidateUserInput_WithValidInput_ReturnsTrue()
    {
        // Arrange
        string validInput = "Teszt";
```
Mivel most csak statikus metódust tesztelünk, a MainWindow példányosítása nem szükséges, így ez a technika most nem kell.

# xUnit Assert metódusok – Jegyzet

Ez a jegyzet összefoglalja a leggyakrabban használt `Assert` metódusokat az xUnit tesztelési keretrendszerben. Minden metódushoz tartozik egy rövid leírás és egy példa.

| **Assert metódus** | **Leírás** | **Példa** |
|--------------------|------------|-----------|
| `Assert.Equal(a, b)` | Ellenőrzi, hogy `a == b` | `Assert.Equal(5, result)` |
| `Assert.NotEqual(a, b)` | Ellenőrzi, hogy `a != b` | `Assert.NotEqual("hiba", user.Name)` |
| `Assert.True(condition)` | Ellenőrzi, hogy a feltétel igaz | `Assert.True(user.Age > 18)` |
| `Assert.False(condition)` | Ellenőrzi, hogy a feltétel hamis | `Assert.False(string.IsNullOrEmpty(user.Email))` |
| `Assert.Null(obj)` | Ellenőrzi, hogy az objektum `null` | `Assert.Null(result)` |
| `Assert.NotNull(obj)` | Ellenőrzi, hogy az objektum nem `null` | `Assert.NotNull(result)` |
| `Assert.Contains(item, collection)` | Ellenőrzi, hogy a gyűjtemény tartalmazza az elemet | `Assert.Contains("teszt", emailList)` |
| `Assert.DoesNotContain(item, collection)` | Ellenőrzi, hogy a gyűjtemény nem tartalmazza az elemet | `Assert.DoesNotContain("hibás", emailList)` |
| `Assert.Throws<T>(action)` | Ellenőrzi, hogy a kód kivételt dob | `Assert.Throws<ArgumentException>(() => new User(null, "email", 25))` |
| `Assert.InRange(value, min, max)` | Ellenőrzi, hogy az érték a megadott tartományban van | `Assert.InRange(user.Age, 18, 99)` |

## Példa kombinált használatra

```csharp
var result = MainWindow.ValidateUserInput("Teszt", "teszt@example.com", "25");

Assert.NotNull(result);
Assert.Equal("Teszt", result.Value.name);
Assert.Equal("teszt@example.com", result.Value.email);
Assert.InRange(result.Value.age, 18, 99);
